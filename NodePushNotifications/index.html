<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Push Notifications with NodeJS</title>

        <meta name="description" content="Creating a simple push notifications server with server-side javascript">
        <meta name="author" content="Dobata">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/beige.css" id="theme">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = 'css/print/pdf.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <div class="slides">
                <section>
                    <h1>NodeJS</h1>
                    <p>
                        <span>
                            <img class="border-none" width="242" height="242" src="./css/images/up2.png">
                        </span>
                        <span>
                            <img class="border-none" width="555" height="242" src="./css/images/nodejs-logo-1.png">
                        </span>
                    </p>
                    <h3>Pushing the boundaries ... or at least notifications</h3>
                    <p>
                        <small>by Dobata / <a href="https://twitter.com/DobromirKralev">@DobromirKralev</a></small>
                    </p>
                </section>

                <section>
                    <h2>Content</h2>
                    <p class="fragment fade-in">What technologies were used</p>
                    <p class="fragment fade-in">Basic Node features</p>
                    <p class="fragment fade-in">NPM</p>
                    <p class="fragment fade-in">Different internet communication architectures</p>
                    <p class="fragment fade-in">Push notification mechanism overview</p>
                    <p class="fragment fade-in">Setting up the Google Cloud Messaging service</p>
                    <p class="fragment fade-in">Some code</p>
                    <p class="fragment fade-in">Server demo</p>
                    <p class="fragment fade-in"><span style="color:#c00">Disclaimer</span>: Possible presence of type'Os &amp; messy code in presentation &amp; demo.<span style="color:#3c3">But hey ... at least the code works</span></p>
                </section>

                <!-- Technologies used section -->
                <section>
                    <section>
                        <h2>NodeJS</h2>
                        <p>
                            <img class="border-none" width="280" height="326" src="./css/images/nodeWha.jpg" alt="Homer">
                        </p>
                        <br/>
                        <span>
                            site: <a href="http://nodejs.org/" target="_blank">nodejs.org</a>
                        </span>
                        <aside class="notes">
                            Node.js is a platform built on Chrome's JavaScript runtime for easily building fast, scalable network applications. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient, perfect for data-intensive real-time applications that run across distributed devices.
                        </aside>
                    </section>
                    <section>
                        <h2>NPM</h2>
                        <p>
                            <img class="border-none" width="500" height="195" src="./css/images/npm-logo.png">
                        </p>
                        <br/>
                        <span>
                            site: <a href="https://www.npmjs.org/" target="_blank">npmjs.org</a>
                        </span>
                        <aside class="notes">
                            The Node package manager (similar to NuGet PM for .NET 'http://www.nuget.org/' or Composer for Php 'https://getcomposer.org/').
                            Used with CLI (sorry GUI users :D). Opensource in the sense that every user can publish/download modules freely. In the future the NPM team claims that there will be functionality for paid packages also.
                        </aside>
                    </section>
                    <section>
                        <h2>Express</h2>
                        <p>
                            <img class="border-none" width="465" height="141" src="./css/images/express.png">
                        </p>
                        <span>
                            site: <a href="http://expressjs.com/" target="_blank">expressjs.com</a>
                        </span>
                        <aside class="notes">
                            Express 3.x is a light-weight web application framework to help organize your web app into MVC architecture on the server side. You can use a variety of choices for your templating language (like ejs, jade, dustjs).

                            You can then use a database like mongodb with mongoose (for modeling) to provide a backend for your node.js app. Express basically helps you manage everything, from routes, to handling requests and views.
                        </aside>
                    </section>

                    <section>
                        <h2>Node-GCM</h2>
                        <span>
                            site: <a href="https://github.com/ToothlessGear/node-gcm" target="_blank">https://github.com/ToothlessGear/node-gcm</a>
                        </span>
                        <aside class="notes">
                            Node module that provides an elementary (and working) API for sending push-notifications to devices with the Google Cloud Messaging services.                           
                        </aside>
                    </section>
                    <section>
                        <h2>Telerik app builder + phonegap pushNotifications plugin</h2>
                        <p class="fragment fade-in">
                            <img class="border-none" width="500" height="400" src="./css/images/vs.png">
                        </p>
                        <p class="fragment fade-in">
                            Dev: 0 / Phonegap: 1
                        </p>
                        <aside class="notes">
                            Initially was only the Phonegap framework, but after some setup difficulties the developer was forced to use the App Builder because of his previous experience with the technology.
                        </aside>
                    </section>
                    <section>
                        <h2>Telerik app builder</h2>
                        <p>
                            <img class="border-none" width="300" height="300" src="./css/images/app-builder.png">
                        </p>
                        <span>
                            site: <a href="http://www.telerik.com/appbuilder" target="_blank">telerik.com/appbuilder</a>
                        </span>
                        <aside class="notes">
                            Product built on top of Phonegap that handles the phonegap nasty installation &amp; setup for you. Has features like device javascript live console &amp; onSync functionality that allows developers NOT to rebuild phonegap projects every time changes are made.

                            The cool new thing about is that now they are ditching 'text-editor' part of the product and are developing a functioning Sublime package AND a NodeJS module. (deep bow) for making such a change.
                        </aside>
                    </section>
                    <section>
                        <h2>Phonegap</h2>
                        <p>
                            <img class="border-none" width="300" height="300" src="./css/images/phonegap.png">
                        </p>
                        <span>
                            sites:
                            <br/>
                            <a href="http://phonegap.com/" target="_blank">phonegap.com</a>
                            <br/>
                            &amp; 
                            <br/>
                            <a href="https://github.com/phonegap-build/PushPlugin" target="_blank">https://github.com/phonegap-build/PushPlugin</a>
                        </span>
                        <aside class="notes">
                            PhoneGap is a free and open source framework that allows you to create mobile apps using standardized web technologies APIs for the platforms(iOs, Android, Windows Phone etc.) you care about. In this example we are going to use a specific plug-in for Phonegap concerning mobile-devices' push-notifications mechanism.
                        </aside>
                    </section>
                    <section>
                        <h2>Google Cloud Messaging</h2>
                        <p>
                            <img class="border-none" width="297" height="170" src="./css/images/gcm.jpg">
                        </p>
                        <span>
                            site: <a href="http://developer.android.com/google/gcm/index.html" target="_blank">developer.android.com/google/gcm/index.html</a>
                        </span>
                    </section>

                    <section>
                        <h2>Other technologies</h2>
                        <p class="fragment fade-in">
                            <span>Grunt - the Javascript task runner / <a href="http://gruntjs.com/" target="_blank">site</a></span>
                        </p>
                        <p class="fragment fade-in">
                            <span>MongoDB - NoSQL (Not only Structured Query Language) database that stores object in a JS-like format / <a href="http://www.mongodb.org/" target="_blank">site</a></span>
                        </p>
                        <p class="fragment fade-in">
                            <span>SASS - CSS precompiler / <a href="http://sass-lang.com/" target="_blank">site</a></span>
                        </p>
                        <p class="fragment fade-in">
                            <span>JS Hybugger / <a href="https://www.jshybugger.com/#!/" target="_blank">site</a></span>
                        </p>
                        <p class="fragment fade-in">curl - HTTP client for server testing without UI </p>
                        <p class="fragment fade-in">Reveal.JS (for an eye-candy presentation) / <a href="http://lab.hakim.se/reveal-js/#/" target="_blank">site</a></p>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>NodeJS the goodparts</h2>
                        <p>
                            <img class="border-none" width="576" height="270" src="./css/images/nodejs-logo.png">
                        </p>
                    </section>
                    <section>
                        <h2>Eventloop</h2>
                        <p>
                            <img class="border-none" width="500" height="266" src="./css/images/event-loop.jpg">
                        </p>
                    </section>
                    <section>
                        <h2>Requiring stuff</h2>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
// getting all module functionality and variables
var simple = require('./simplest-module-ever-complete');
var express = require('express');

// getting single variable/function from the module
var inspect = require('sys').inspect;
                        </code></pre>
                    </section>
                    <section>
                        <h2>NodeJS Modules</h2>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
//exportig functions
exports.myFunc = function myFunction() {
  return 'I obey, Master!';
};

//exporting global naspace variables
exports.egg = 'egg: 1';

//exporting whole modules
var mod = (function () {
    var modulePatternObj = {};

    function fun() {

    }

    modulePatternObj.fun = fun;

    return modulePatternObj;
})();

exports.mod = mod;
                        </code></pre>
                        <p class="fragment fade-in">
                            Modularising javascript code
                        </p>
                        <p class="fragment fade-in">
                            Plug and play (or in our case code) nature of node modules
                        </p>
                    </section>
                    <section>
                        <h2>Objects Stream Nature</h2>
                        <p>
                            <img class="border-none" width="400" height="224" src="./css/images/cars-working-track.jpg">
                        </p>
                    </section>
                    <section>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
var fs = require("fs");
var es = require("event-stream");
var vsprintf = require("sprintf").vsprintf;

// Read File
fs.createReadStream("input/people.tsv")
// Split Strings
.pipe(es.split("\n"))
// Split Strings into Array
.pipe(es.mapSync(function(data) {
    return data.split("\t");
}))
// Convert Array w/ Sprintf
.pipe(es.mapSync(function(data) {
    return vsprintf("<tr><td><a href='%2$s'>%1$s</a></td><td>%3$s</td></tr>", data);
}))
// Join Strings
.pipe(es.join("\n"))
// Concat Strings
.pipe(es.wait())
// Wrap Strings
.pipe(es.mapSync(function(data) {
    return "<table><tr><th>Name</th><th>City</th></tr>\n" + data + "\n</table>";
}));
                        </code></pre>
                    </section>
                    <section>
                        <h2>I/O operations</h2>
                        <p class="fragment fade-in">Sync</p>
                        <p class="fragment fade-in">aSync</p>
                    </section>
                    <section>
                        <h2>Dark side of the Node</h2>
                        <p>
                            <img class="border-none" width="600" height="600" src="./css/images/dark-side.jpg">
                        </p>
                    </section>
                    <section>
                        <h2>Callback hell</h2>
                        <p>
                            <img class="border-none" width="729" height="527" src="./css/images/callback-hell.png">
                        </p>
                        <p class="fragment fade-in">
                            <span><a href="http://callbackhell.com/" target="_blank">callbackhell.com</a></span>
                        </p>
                    </section>
                    <section>
                        <h2>Other cons?</h2>
                        <p class="fragment fade-in">"It's Javascript!"</p>
                    </section>
                </section>

                <section>
                    <h2>NPM</h2>
                    <p class="fragment fade-in">Creating a npm file: 'npm-init' command</p>
                    <p class="fragment fade-in">Downloading packages: 'npm install &lt;package-name&gt; --save' </p>
                </section>

                <section>
                    <h2>Different Communication Architectures</h2>
                    <p class="fragment">
                            <span><a href="http://stackoverflow.com/questions/11077857/what-are-long-polling-websockets-server-sent-events-sse-and-comet" target="_blank">Stackoverflow reference</a></span>
                    </p>
                </section>

                <section>
                    <h2>The Push Notifications Architecture</h2>
                    <p class="fragment fade-in">
                        <img class="border-none" width="467" height="500" src="./css/images/apn-architecture.jpg">
                    </p>
                </section>

                <section>
                    <h2>Google developers console</h2>

                    <p class="fragment">
                            <span><a href="https://console.developers.google.com/project" target="_blank">Go to dev console</a></span>
                    </p>
                </section>

                <section>
                    <section>
                        <h2>Code examples time</h2>
                    </section>
                    <section>
                        <h2>Server side</h2>
                    </section>
                    <section>
                        <h3>Config.json</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
{
    "host": "localhost",
    "port": "1337",
    "gcmApiKey": "AIzaSyA4uj1ioehlB2yscUX8pnRwc4mQenm-x3U"
}
                        </code></pre>
                    </section>
                    <section>
                        <h3>Pn.js</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
var gcm = require('node-gcm');

var pn = (function (config) {
    var sender = new gcm.Sender(config.gcmApiKey),
        deviceList = {},
        messageList = {},
        lastMessageId = 0,
        pnModule = {};

    function addDevice (deviceObj) {
        if(deviceList[deviceObj.uuid] === undefined) {
            deviceObj.timeStamp = new Date();
            deviceList[deviceObj.uuid] = deviceObj;
        }
        console.log('Added device:' + JSON.stringify(deviceList[deviceObj.uuid]));
    }

    function removeDevice (deviecObjUuid) {
        if(deviceList[deviecObjUuid] !== undefined) {
            console.log('Removing device:' + JSON.stringify(deviceList[deviecObjUuid]));
            delete deviceList[deviecObjUuid];
        }
    }

    function sendMessage (message, devicesToNotify) {
        if(devicesToNotify === undefined) {
            //broadcasting to all devices if no-particular are specified
            var devicesToNotify = [];
            for (var uuid in deviceList) {
                devicesToNotify.push(deviceList[uuid].token);
            }
        }

        var message = new gcm.Message({
                collapseKey: 'push demo',
                delayWhileIdle: true,
                timeToLive: 3,
                data: {
                    message : message
                }
            });

        sender.send(message, devicesToNotify, 4, function (err, result) {
            console.log(err);
            console.log(result);
        });

        messageList[lastMessageId++] = message;
    }

    pnModule.addDevice = addDevice;
    pnModule.removeDevice = removeDevice;
    pnModule.sendMessage = sendMessage;

    return pnModule;
});

module.exports = pn;
                        </code></pre>
                    </section>
                    <section>
                        <h3>Server.js</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
var fs = require('fs'),
    express = require('express'),
    bodyparser = require('body-parser'), //middleware specific for express (express no longer contains in it's self such mechanisms)
    config = JSON.parse(fs.readFileSync('config.json')),
    pn = require('./pn.js'),
    host = config.host,
    port = config.port,
    app = express(),
    pn = pn(config);


// serves main page
app.get('/', function(req, res) {
    res.sendfile('./index.html');
});

//NOTE: needed to parse json
app.use(bodyparser.json());

app.post('/register', function(req, res) {
    //NOTE: req.body is an already parsed JSON object
    pn.addDevice(req.body); // adding device info to our simulated database
    res.send(200);
});

app.post('/unregister', function(req, res) {
    console.log(req.body.uuid);
    pn.removeDevice(req.body.uuid); // removing device info from our simulated database
    res.send(200);
});


//this request is sent from within the server when we want to send a message to our users
app.post('/sendmessage', function(req, res) {
    pn.sendMessage(req.body.message);
    res.send(200);
});

//for cross domain calls
app.all('*', function(req, res, next) {
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "X-Requested-With");
    next();
 });

//uploading static css/js files and whatnot
app.use('/static', express.static(__dirname + '/static')); 

//config for json consumption on post


var server = app.listen(port, function() {
    console.log('Listening on port %d', server.address().port);
});
                        </code></pre>
                    </section>
                    
                    <section>
                        <h2>Client side</h2>
                    </section>
                    <section>
                        <h3>AppConfig.js</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
var appConfig = {
    senderID: "2742728706", //GCM client ID (obtained when registering your app in Google Cloud Messaging)
    sofiaWork: 'http://192.168.0.179:1337',
    registerDeviceUrl: "/register",
    unregisterDeviceUrl: "/unregister"
}
                        </code></pre>
                    </section>
                    <section>
                        <h3>App.js</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
(function ($) {
    $(document).on('deviceready', function() {
        $('#tabs').tabs();
    })

    var currentServerUrl = appConfig.sofiaWork;
    
    $(document).on('touchend', '.subscribe', function(e) {
        var token = appConfig.token,
            uuid = device.uuid;
        $.ajax({
            url: currentServerUrl + appConfig.registerDeviceUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                'token': token,
                'uuid': uuid
            }),
            success: function (data) {
                console.log('success man');
                console.log(data);
            },
            error: function (error) {
                console.log(error);
            }
        }); 
    });

    $(document).on('touchend', '.unsubscribe', function(e) {
        var token = appConfig.token,
            uuid = device.uuid;
        $.ajax({
            url: currentServerUrl + appConfig.unregisterDeviceUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                'token': token,
                'uuid': uuid
            }),
            success: function (data) {
                console.log('success man');
                console.log(data);
            },
            error: function (error) {
                console.log(error);
            }
        }); 
    });

    $(document).on('touchend', '.clear-messages', function (e) {
        $('.messages-container').empty();
    });
})(jQuery);
                        </code></pre>       
                    </section>
                    <section>
                        <h3>PushNotifications.js</h3>
                        <pre><code class="javascript" data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
var pushNotificationsManager = (function ($) {
    
    var managerModule = {}, //instantiating module
        pushNotification = null // phonegap pushnotifications plugin object;

    $(document).on('deviceready', function () {
        pushNotification = window.plugins.pushNotification;
        if(!appConfig.token) {
            registerDeviceForPushNotifications();
        }
    });

    function gcmTokenSuccessHandler (result) {
        // console.log('Token res:' + result);
        appConfig.token = result.token;
    }

    function gcmTokenErrorHandler (error) {
        console.log(error);
    }

    //note: function MUST BE globally exposed
    window.onNotificationGCM = function (e) {
        console.log(e.event);

        switch( e.event ) {
            case 'registered': 
                if ( e.regid.length > 0 ) {
                    // Your GCM push server needs to know the regID before it can push to this device
                    // here is where you might want to send it the regID for later use.
                    console.log("regID = " + e.regid);
                    appConfig.token = e.regid;
                    // TODO: send regId to server
                }
            break;

            case 'message':
                // if this flag is set, this notification happened while we were in the foreground.
                // you might want to play a sound to get the user's attention, throw up a dialog, etc.
                if ( e.foreground ) {
                    // if the notification contains a soundname, play it.
                    // var my_media = new Media("/android_asset/www/"+e.soundname);
                    // my_media.play();
                }
                else {  // otherwise we were launched because the user touched a notification in the notification tray.
                    if ( e.coldstart ) {
                    }
                    else {
                    }
                }
                //default
                if($('.messages-container').is(':empty')) {
                    $('.messages-container').append('&lt;li&gt;' + e.payload.message + '&lt;/li&gt;');
                }
                else {
                    $('.messages-container li:first-child').before('&lt;li&gt;' + e.payload.message + '&lt;/li&gt;');   
                }
            break;

            case 'error':
                //handle errors
            break;

            default:
                
            break;
        }
    }

    function registerDeviceForPushNotifications () {
        if( device.platform == 'android' || device.platform == 'Android' || device.platform == "Amazon" || device.platform == "amazon") {
            // register to GCM 
            // note: 'ecb' value should be a string name of the callback function
            pushNotification.register(
                gcmTokenSuccessHandler,
                gcmTokenErrorHandler, 
                {
                    "senderID": appConfig.senderID,
                    "ecb": "onNotificationGCM" //event callback that gets called when your device receives a notification
                });
        }
        else {   
            // register to APN
            pushNotification.register(
                tokenHandler,
                errorHandler, {
                    "badge": "true",
                    "sound": "true",
                    "alert": "true",
                    "ecb": "onNotificationAPN"
                });
        }
    }

    return managerModule;
})(jQuery);
                        </code></pre>
                    </section>
                </section>

                <section>
                    <h2>PN Server Demo</h2>
                    <p class="fragment fade-in">
                        <img class="border-none" width="500" height="400" src="./css/images/time.jpg">
                    </p>
                </section>

                <section>
                    <h2>FIN</h2>
                    <p>
                        <img class="border-none" width="500" height="400" src="./css/images/zoidberg.jpg">
                    </p>
                </section>

            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { 
                        hljs.initHighlightingOnLoad(); 
                    } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
